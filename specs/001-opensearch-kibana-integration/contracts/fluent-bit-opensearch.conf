# Contract: Fluent-bit конфигурация для отправки в OpenSearch
# Этот файл заменит существующий config/fluent-bit/fluent-bit.conf

[SERVICE]
    Flush         1
    Log_Level     info
    Daemon        off
    HTTP_Server   On
    HTTP_Listen   0.0.0.0
    HTTP_Port     2020
    storage.type  memory
    storage.metrics on

# Прием логов через Forward протокол
[INPUT]
    Name              forward
    Listen            0.0.0.0
    Port              24224
    Tag               app
    Mem_Buf_Limit     64MB

# Парсинг JSON логов (если приложение отправляет JSON)
[FILTER]
    Name parser
    Match app
    Key_Name log
    Parser json
    Reserve_Data On

# Добавление метаданных
[FILTER]
    Name record_modifier
    Match app
    Record hostname ${HOSTNAME}
    Record cluster arbitrage-scanner-dev

# Вывод в OpenSearch
[OUTPUT]
    Name  opensearch
    Match app
    Host  opensearch
    Port  9200
    Index fluentbit
    Type  _doc
    HTTP_User admin
    HTTP_Passwd Admin123!
    tls   Off
    tls.verify Off
    Suppress_Type_Name On
    Logstash_Format On
    Logstash_Prefix fluentbit
    Logstash_DateFormat %Y.%m.%d
    Retry_Limit 5
    Buffer_Size 5MB

# (Опционально) Вывод в stdout для отладки
# Закомментировать после проверки работоспособности
[OUTPUT]
    Name  stdout
    Match app
    Format json_lines
