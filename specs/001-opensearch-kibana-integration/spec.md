# Feature Specification: OpenSearch и Kibana для мониторинга логов и метрик

**Feature Branch**: `001-opensearch-kibana-integration`
**Created**: 2025-11-16
**Status**: Draft
**Input**: User description: "Добавь в существующий проект в docker-compose.minimal.yml opensearch и kibana. Отправляй данные из fluent-bit в opensearch. Так же в kibana настрой метрики количества запросов на сервер от пользователей."

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Централизованный просмотр логов приложения (Priority: P1)

DevOps инженер или разработчик может просматривать все логи приложения arbitrage-scanner в едином интерфейсе для быстрого поиска и анализа проблем.

**Why this priority**: Это базовая функциональность, необходимая для отладки и мониторинга работы приложения. Без возможности просмотра логов невозможно эффективно диагностировать проблемы.

**Independent Test**: Можно полностью протестировать запуском docker-compose окружения, генерацией логов из приложения и проверкой их отображения в Kibana. Доставляет конкретную ценность - централизованный доступ к логам без необходимости подключения к контейнерам.

**Acceptance Scenarios**:

1. **Given** Docker окружение запущено, **When** приложение arbitrage-scanner генерирует логи, **Then** эти логи отображаются в интерфейсе Kibana в течение 5 секунд
2. **Given** пользователь открывает Kibana, **When** использует поиск по тексту лога, **Then** система находит и отображает соответствующие логи
3. **Given** логи поступают из нескольких сервисов, **When** пользователь фильтрует по имени сервиса, **Then** отображаются только логи выбранного сервиса

---

### User Story 2 - Мониторинг количества запросов к серверу (Priority: P2)

DevOps инженер или Product Owner может видеть метрики количества HTTP запросов к серверу arbitrage-scanner для понимания нагрузки и паттернов использования.

**Why this priority**: Это важная функциональность для мониторинга производительности и понимания паттернов использования, но система может работать без неё на начальном этапе.

**Independent Test**: Можно протестировать отправкой тестовых HTTP запросов к arbitrage-scanner и проверкой отображения метрик в Kibana. Доставляет независимую ценность - визуализация нагрузки на сервер.

**Acceptance Scenarios**:

1. **Given** пользователь открывает дашборд метрик в Kibana, **When** просматривает метрики запросов, **Then** видит общее количество запросов за выбранный период времени
2. **Given** приложение получает HTTP запросы, **When** запросы обрабатываются, **Then** счётчик запросов в метриках увеличивается в течение 5 секунд
3. **Given** пользователь выбирает временной диапазон, **When** применяет фильтр, **Then** метрики отображаются только за выбранный период
4. **Given** происходят запросы к разным endpoints, **When** пользователь просматривает метрики, **Then** может видеть разбивку по типам запросов (GET, POST и т.д.)

---

### User Story 3 - Анализ истории логов и метрик (Priority: P3)

Аналитик или разработчик может просматривать исторические данные логов и метрик для анализа трендов и выявления паттернов.

**Why this priority**: Это расширенная функциональность для долгосрочного анализа, которая полезна, но не критична для базовой работы системы мониторинга.

**Independent Test**: Можно протестировать накоплением данных в течение определённого времени и проверкой доступности исторических данных через интерфейс Kibana. Доставляет ценность - возможность ретроспективного анализа.

**Acceptance Scenarios**:

1. **Given** система работает несколько дней, **When** пользователь запрашивает данные за прошлые периоды, **Then** логи и метрики доступны за последние 7 дней
2. **Given** пользователь анализирует тренды, **When** строит графики метрик по дням, **Then** может видеть динамику изменения нагрузки
3. **Given** нужно найти инцидент в прошлом, **When** пользователь фильтрует логи по временному диапазону и уровню серьёзности, **Then** находит релевантные записи

---

### Edge Cases

- Что происходит когда OpenSearch недоступен? Fluent-bit должен буферизировать логи в памяти (memory buffer) для предотвращения потери данных во время кратковременных сбоев. При перезапуске Fluent-bit буферизованные данные будут потеряны (приемлемо для development окружения)
- Как система обрабатывает большой объём логов? Должна быть настроена ротация индексов для предотвращения переполнения диска
- Что происходит при перезапуске сервисов? Логи и метрики должны продолжить поступать без потери данных (за исключением данных в memory buffer Fluent-bit)
- Как обрабатываются логи с некорректным форматом? Fluent-bit должен логировать ошибки парсинга, но не прерывать работу
- Что если объём логов превышает доступную память? Должны быть настроены лимиты retention для автоматической очистки старых данных

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: Система ДОЛЖНА включать OpenSearch сервис в docker-compose.minimal.yml для хранения логов и метрик
- **FR-002**: Система ДОЛЖНА включать Kibana сервис в docker-compose.minimal.yml для визуализации данных
- **FR-003**: Fluent-bit ДОЛЖЕН отправлять все собранные логи в OpenSearch вместо вывода в stdout
- **FR-004**: Система ДОЛЖНА сохранять логи приложения с метаданными (timestamp, уровень лога, имя сервиса, сообщение)
- **FR-005**: Kibana ДОЛЖНА быть доступна через веб-интерфейс для просмотра логов и метрик
- **FR-006**: Система ДОЛЖНА собирать и хранить метрики HTTP запросов к arbitrage-scanner (количество, тип, endpoint)
- **FR-007**: В Kibana ДОЛЖЕН быть создан дашборд для отображения метрик количества запросов
- **FR-008**: Система ДОЛЖНА поддерживать поиск по логам с использованием текстовых запросов
- **FR-009**: Система ДОЛЖНА поддерживать фильтрацию логов по времени, уровню серьёзности и сервису
- **FR-010**: OpenSearch ДОЛЖЕН быть настроен с персистентным хранилищем для сохранения данных между перезапусками
- **FR-011**: Система ДОЛЖНА корректно стартовать все сервисы в правильном порядке с использованием depends_on
- **FR-012**: Конфигурация fluent-bit ДОЛЖНА быть обновлена для отправки данных в OpenSearch
- **FR-013**: Система ДОЛЖНА хранить логи минимум за последние 7 дней для анализа
- **FR-014**: Дашборд метрик ДОЛЖЕН отображать данные в виде графиков с временными рядами
- **FR-015**: Kibana ДОЛЖНА быть защищена базовой аутентификацией (логин/пароль) для контроля доступа к логам и метрикам
- **FR-016**: Fluent-bit ДОЛЖЕН быть настроен с memory buffer размером 64MB для буферизации логов при временной недоступности OpenSearch
- **FR-017**: Система ДОЛЖНА включать документацию с пошаговыми инструкциями по первоначальной настройке index pattern в Kibana для просмотра логов
- **FR-018**: Все компоненты системы мониторинга (OpenSearch, Fluent-bit, Kibana) ДОЛЖНЫ быть настроены с Docker health checks для контроля работоспособности

### Key Entities

- **Лог-запись**: Единица логирования, содержащая временную метку, уровень серьёзности (info, warn, error), имя сервиса-источника, текст сообщения, и дополнительные поля контекста
- **Метрика HTTP запроса**: Информация о входящем запросе, включающая временную метку, HTTP метод (GET, POST и т.д.), путь endpoint, код ответа, время обработки, IP адрес клиента
- **Индекс логов**: Коллекция лог-записей, организованная по временным периодам для эффективного поиска и хранения
- **Дашборд**: Визуальная панель с графиками и таблицами метрик для мониторинга системы

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: Пользователь может найти любой лог приложения за последние 7 дней за время не более 10 секунд через поисковый интерфейс
- **SC-002**: Логи появляются в Kibana не позднее чем через 5 секунд после генерации в приложении
- **SC-003**: Дашборд метрик обновляется автоматически и показывает актуальные данные с задержкой не более 10 секунд
- **SC-004**: Система корректно стартует все сервисы (postgres, kafka, fluent-bit, opensearch, kibana, arbitrage-scanner) за одну команду docker-compose up
- **SC-005**: Пользователь может фильтровать логи по уровню серьёзности (info/warn/error) и получать результаты менее чем за 5 секунд
- **SC-006**: Метрики запросов отображают минимум следующую информацию: общее количество запросов, разбивку по HTTP методам, временные графики нагрузки
- **SC-007**: Система сохраняет все логи и метрики при перезапуске контейнеров (данные персистентны)
- **SC-008**: Docker-compose окружение использует не более 4GB RAM в нормальном режиме работы для всех сервисов вместе
- **SC-009**: Пользователь может проверить статус работоспособности всех компонентов мониторинга через команду docker-compose ps и видеть healthy статус для OpenSearch, Fluent-bit и Kibana

## Clarifications

### Session 2025-11-16

- Q: Требуется ли аутентификация для доступа к Kibana в development окружении? → A: Базовая аутентификация (логин/пароль для всех пользователей)
- Q: Какой механизм буферизации должен использовать Fluent-bit при недоступности OpenSearch? → A: Memory buffer (буфер в памяти)
- Q: Какой размер memory buffer должен быть настроен в Fluent-bit? → A: 64MB
- Q: Как должна быть выполнена первоначальная настройка index pattern в Kibana? → A: Документированная ручная настройка (пошаговая инструкция в README)
- Q: Как должна контролироваться работоспособность компонентов системы мониторинга? → A: Docker health checks для каждого компонента (opensearch, fluent-bit, kibana)

## Assumptions

- OpenSearch будет использовать версию 2.x (стабильная и совместимая с Kibana)
- Kibana будет версии, совместимой с OpenSearch 2.x
- Fluent-bit уже настроен для сбора логов из приложения через Forward protocol
- HTTP логи приложения arbitrage-scanner содержат достаточную информацию для извлечения метрик запросов
- Retention период для логов будет 7 дней (баланс между доступностью данных и использованием диска)
- Индексы будут автоматически ротироваться на ежедневной основе
- Дашборд метрик будет создан вручную через UI Kibana (не программно через API)
- Index pattern в Kibana настраивается вручную по документированной инструкции при первом запуске
- Система работает в development окружении (не production), поэтому не требуется высокая доступность и репликация
