# Feature Specification: Recalculate Arbitrage Opportunities

**Feature Branch**: `001-recalculate-arbitrage`
**Created**: 2025-10-26
**Status**: Draft
**Input**: User description: "Реализуй обработку события recalculate в бизнес логики. Что должно происходить - нужно перерасчитать возможные арбитражные ситуации. Нужно взять все доступные CexPrice применить к ним алгоритм поиска арбитражных ситуаций и сохранить арбитражные возможности в репозиторий. Репозитории необходимо использовать inMemory, максимально простые. CexPrice пока бери из моковых данный, создай большой набор данных чтобы можно было проверить алгоритм. Так же по возможности оптимизируй расчет так чтобы он максимально быстро расчитывал арбитражные возможности."

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Automatic Recalculation Trigger (Priority: P1)

Система автоматически пересчитывает арбитражные возможности при получении события recalculate. Это позволяет трейдерам получать актуальные данные о доступных арбитражных ситуациях на основе текущих цен с бирж.

**Why this priority**: Это основная функциональность, без которой система не может работать. Автоматический пересчёт - ядро системы поиска арбитража.

**Independent Test**: Можно полностью протестировать отправкой события RECALCULATE и проверкой, что система возвращает список найденных арбитражных возможностей с корректными данными (токены, биржи, спреды).

**Acceptance Scenarios**:

1. **Given** система имеет набор цен с разных бирж, **When** получено событие RECALCULATE, **Then** система анализирует все доступные цены и возвращает список найденных арбитражных возможностей
2. **Given** на двух биржах разные цены на один токен с прибыльным спредом, **When** выполнен пересчёт, **Then** система создаёт арбитражную возможность с указанием биржи покупки, биржи продажи и процента спреда
3. **Given** цены на всех биржах одинаковые, **When** выполнен пересчёт, **Then** система возвращает пустой список арбитражных возможностей
4. **Given** система завершила пересчёт, **When** получен результат, **Then** результат содержит количество найденных возможностей и время обработки в миллисекундах

---

### User Story 2 - Optimized Large Dataset Processing (Priority: P2)

Система эффективно обрабатывает большой объём данных о ценах (сотни пар токен-биржа) и быстро находит все возможные арбитражные ситуации.

**Why this priority**: Производительность критична для арбитражной торговли - возможности существуют короткое время. Быстрый расчёт даёт конкурентное преимущество.

**Independent Test**: Можно протестировать с набором из 100+ цен на разных биржах и измерить время выполнения пересчёта. Успешный тест - обработка за приемлемое время (менее 1 секунды для 1000 цен).

**Acceptance Scenarios**:

1. **Given** система имеет 1000 ценовых записей с 10 бирж и 100 токенов, **When** выполняется пересчёт, **Then** обработка завершается менее чем за 1 секунду
2. **Given** выполняется пересчёт для большого набора данных, **When** алгоритм работает, **Then** используется оптимальная стратегия сравнения (не O(n²), а более эффективная)
3. **Given** система нашла множество арбитражных возможностей, **When** возвращается результат, **Then** все возможности отсортированы по убыванию спреда (самые выгодные первыми)

---

### User Story 3 - In-Memory Repository Storage (Priority: P3)

Найденные арбитражные возможности сохраняются во внутренний репозиторий для последующего доступа через READ и SEARCH операции.

**Why this priority**: Хранение результатов необходимо для интеграции с остальной системой, но может быть реализовано после базового алгоритма пересчёта.

**Independent Test**: Можно протестировать выполнением RECALCULATE, затем READ/SEARCH запросами для проверки, что данные доступны и корректны.

**Acceptance Scenarios**:

1. **Given** выполнен успешный пересчёт с найденными возможностями, **When** выполняется сохранение в репозиторий, **Then** каждая возможность сохраняется с уникальным ID и timestamp начала
2. **Given** выполнен новый пересчёт, **When** находятся новые арбитражные ситуации, **Then** старые возможности помечаются как завершённые (устанавливается endTimestamp), новые добавляются
3. **Given** в репозитории есть сохранённые возможности, **When** выполняется READ по ID, **Then** возвращается корректная арбитражная возможность с полными данными
4. **Given** в репозитории есть сохранённые возможности, **When** выполняется SEARCH с фильтром, **Then** возвращаются только соответствующие фильтру возможности

---

### Edge Cases

- Что происходит, когда набор цен пустой (нет данных с бирж)?
- Как система обрабатывает ситуацию, когда для токена доступна цена только на одной бирже?
- Что происходит при параллельных запросах RECALCULATE?
- Как обрабатывается ситуация с некорректными/устаревшими ценовыми данными?
- Что происходит, когда спред отрицательный (цена покупки выше цены продажи)?
- Как система реагирует на минимальные спреды (например, 0.01%)?

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: Система ДОЛЖНА обрабатывать событие RECALCULATE в бизнес-логике
- **FR-002**: Система ДОЛЖНА загружать все доступные ценовые данные CexPrice из источника данных
- **FR-003**: Система ДОЛЖНА применять алгоритм поиска арбитражных ситуаций ко всем загруженным ценам
- **FR-004**: Система ДОЛЖНА идентифицировать арбитражные возможности как пары (токен, биржа покупки, биржа продажи) с положительным спредом
- **FR-005**: Система ДОЛЖНА вычислять процент спреда для каждой найденной возможности: `(sellPrice - buyPrice) / buyPrice * 100`
- **FR-006**: Система ДОЛЖНА сохранять найденные арбитражные возможности в in-memory репозиторий
- **FR-007**: Система ДОЛЖНА возвращать результат пересчёта с количеством найденных возможностей и временем обработки
- **FR-008**: Система ДОЛЖНА использовать моковые данные для CexPrice до интеграции с реальными биржами
- **FR-009**: Моковый набор данных ДОЛЖЕН включать минимум 10 различных токенов и 5 различных бирж
- **FR-010**: Моковый набор данных ДОЛЖЕН содержать минимум 100 ценовых записей для тестирования производительности
- **FR-011**: Алгоритм поиска ДОЛЖЕН быть оптимизирован для быстрой обработки больших объёмов данных: использовать группировку по токенам (O(n) вместо O(n²)), Kotlin sequences для lazy evaluation, минимизировать промежуточные коллекции
- **FR-012**: Система ДОЛЖНА обрабатывать ситуацию с отсутствующими данными корректно (возвращать пустой результат)
- **FR-013**: Каждая сохранённая арбитражная возможность ДОЛЖНА иметь уникальный ID
- **FR-014**: Каждая арбитражная возможность ДОЛЖНА включать timestamp начала (startTimestamp)
- **FR-015**: in-memory репозиторий ДОЛЖЕН поддерживать операции: create, read by ID, findAll, findActive (возможности без endTimestamp)
- **FR-016**: Система ДОЛЖНА учитывать минимальный порог прибыльности спреда: минимум 0.1%
- **FR-017**: Система ДОЛЖНА игнорировать ценовые пары с одинаковыми ценами (нулевой спред)
- **FR-018**: Система ДОЛЖНА корректно обрабатывать токены, доступные только на одной бирже (не создавать возможности)

### Key Entities

- **CexPrice**: Ценовые данные с CEX биржи, содержит токен, биржу, цену и временную метку
- **CexToCexArbitrageOpportunity**: Найденная арбитражная возможность между двумя CEX биржами, содержит токен, биржу покупки с ценой, биржу продажи с ценой, спред, временные метки начала и окончания
- **RecalculateResult**: Результат пересчёта, содержит количество найденных возможностей и время обработки
- **ArbitrageOpportunityRepository**: in-memory хранилище арбитражных возможностей с операциями CRUD
- **CexPriceRepository**: in-memory хранилище ценовых данных с моковыми данными

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: Система успешно обрабатывает событие RECALCULATE и возвращает результат с найденными возможностями
- **SC-002**: Алгоритм корректно идентифицирует все прибыльные арбитражные ситуации из набора тестовых данных (100% точность на известном наборе)
- **SC-003**: Система обрабатывает 1000 ценовых записей менее чем за 1 секунду на стандартном оборудовании
- **SC-004**: in-memory репозиторий сохраняет все найденные возможности и обеспечивает доступ через READ/SEARCH операции
- **SC-005**: Моковый набор данных содержит минимум 100 ценовых записей и позволяет найти минимум 10 различных арбитражных возможностей
- **SC-006**: Результат пересчёта включает точное количество найденных возможностей и время обработки в миллисекундах
- **SC-007**: Система корректно обрабатывает edge cases: пустой набор данных, одиночные цены, нулевые спреды

## Assumptions

- Используется существующая модель Context для передачи данных между слоями
- Command.RECALCULATE уже определён в системе
- Структура CexPrice, CexToCexArbitrageOpportunity, RecalculateResult уже существует
- Минимальный порог прибыльности спреда установлен в 0.1% на основе стандартов арбитражной торговли
- Алгоритм поиска использует группировку цен по токенам для оптимизации (избегает O(n²) сравнений всех пар)
- in-memory репозиторий использует простые структуры данных (Map/List) без внешних зависимостей
- Моковые данные генерируются программно для удобства тестирования различных сценариев
- Временные метки для ценовых данных генерируются в момент создания моков
